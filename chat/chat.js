var windowFocus=true;var username="me";var chatHeartbeatCount=0;var minChatHeartbeat=1000;var maxChatHeartbeat=3000;var chatHeartbeatTime=minChatHeartbeat;var originalTitle;var blinkOrder=0;var chatboxFocus=new Array();var newMessages=new Array();var newMessagesWin=new Array();var chatBoxes=new Array();$(document).ready(function(){originalTitle=document.title;startChatSession();$([window,document]).blur(function(){windowFocus=false}).focus(function(){windowFocus=true;document.title=originalTitle})});function restructureChatBoxes(){align=0;for(x in chatBoxes){chatboxtitle=chatBoxes[x];if($("#chatbox_"+chatboxtitle).css("display")!="none"){if(align==0){$("#chatbox_"+chatboxtitle).css("right","20px")}else{width=(align)*(225+7)+20;$("#chatbox_"+chatboxtitle).css("right",width+"px")}align++}}}function chatWith(a,b){createChatBox(a,b);$("#chatbox_"+a+" .chatboxtextarea").focus();}function createChatBox(c,a,b){if($("#chatbox_"+c).length>0){if($("#chatbox_"+c).css("display")=="none"){$("#chatbox_"+c).css("display","block");restructureChatBoxes()}$("#chatbox_"+c+" .chatboxtextarea").focus();return}$(" <div />").attr("id","chatbox_"+c).addClass("chatbox").html('<div style="cursor:pointer" onclick="javascript:toggleChatBoxGrowth(\''+c+'\')"><div class="chatboxhead"><div class="chatboxtitle">'+a+'</div><div class="chatboxoptions">- <a href="javascript:void(0)" onclick="javascript:closeChatBox(\''+c+'\')"> X </a></div><br clear="all"/></div></div><div class="chatboxcontent"></div><div class="chatboxinput"><textarea class="chatboxtextarea" onkeydown="javascript:return checkChatBoxInputKey(event,this,\''+c+"','"+a+"');\"></textarea></div>").appendTo($("body"));$("#chatbox_"+c).css("bottom","0px");chatBoxeslength=0;for(x in chatBoxes){if($("#chatbox_"+chatBoxes[x]).css("display")!="none"){chatBoxeslength++}}if(chatBoxeslength==0){$("#chatbox_"+c).css("right","20px")}else{width=(chatBoxeslength)*(225+7)+20;$("#chatbox_"+c).css("right",width+"px")}chatBoxes.push(c);if(b==1){minimizedChatBoxes=new Array();if($.cookie("chatbox_minimized")){minimizedChatBoxes=$.cookie("chatbox_minimized").split(/\|/)}minimize=0;for(j=0;j<minimizedChatBoxes.length;j++){if(minimizedChatBoxes[j]==c){minimize=1}}if(minimize==1){$("#chatbox_"+c+" .chatboxcontent").css("display","none");$("#chatbox_"+c+" .chatboxinput").css("display","none")}}chatboxFocus[c]=false;$("#chatbox_"+c+" .chatboxtextarea").blur(function(){chatboxFocus[c]=false;$("#chatbox_"+c+" .chatboxtextarea").removeClass("chatboxtextareaselected")}).focus(function(){chatboxFocus[c]=true;newMessages[c]=false;$("#chatbox_"+c+" .chatboxhead").removeClass("chatboxblink");$("#chatbox_"+c+" .chatboxtextarea").addClass("chatboxtextareaselected")});$("#chatbox_"+c).click(function(){if($("#chatbox_"+c+" .chatboxcontent").css("display")!="none"){$("#chatbox_"+c+" .chatboxtextarea").focus()}});$("#chatbox_"+c).show()}function chatHeartbeat(){var c=0;if(windowFocus==false){var b=0;var a=0;for(x in newMessagesWin){if(newMessagesWin[x]==true){++b;if(b>=blinkOrder){document.title=x+" says...";a=1;break}}}if(a==0){document.title=originalTitle;blinkOrder=0}else{++blinkOrder}}else{for(x in newMessagesWin){newMessagesWin[x]=false}}for(x in newMessages){if(newMessages[x]==true){if(chatboxFocus[x]==false){$("#chatbox_"+x+" .chatboxhead").toggleClass("chatboxblink")}}}$.ajax({url:"chat.php?action=chatheartbeat",cache:false,dataType:"json",success:function(d){$.each(d.items,function(e,f){if(f){chatboxtitle=f.f;cuser=f.u;if($("#chatbox_"+chatboxtitle).length<=0){createChatBox(chatboxtitle,cuser)}if($("#chatbox_"+chatboxtitle).css("display")=="none"){$("#chatbox_"+chatboxtitle).css("display","block");restructureChatBoxes()}if(f.s==1){f.f=username}if(f.s==2){$("#chatbox_"+chatboxtitle+" .chatboxcontent").append('<div class="chatboxmessage"><span class="chatboxinfo">'+f.m+"</span></div>")}else{newMessages[chatboxtitle]=true;newMessagesWin[f.u]=true;$("#chatbox_"+chatboxtitle+" .chatboxcontent").append('<div class="chatboxmessage"><span class="chatboxmessagefrom">'+f.u+':&nbsp;&nbsp;</span><span class="chatboxmessagecontent">'+f.m+"</span></div>")}$("#chatbox_"+chatboxtitle+" .chatboxcontent").scrollTop($("#chatbox_"+chatboxtitle+" .chatboxcontent")[0].scrollHeight);c+=1}});chatHeartbeatCount++;if(c>0){chatHeartbeatTime=minChatHeartbeat;chatHeartbeatCount=1}else{if(chatHeartbeatCount>=10){chatHeartbeatTime*=2;chatHeartbeatCount=1;if(chatHeartbeatTime>maxChatHeartbeat){chatHeartbeatTime=maxChatHeartbeat}}}setTimeout("chatHeartbeat();",chatHeartbeatTime)}})}function closeChatBox(a){$("#chatbox_"+a).css("display","none");restructureChatBoxes();$.post("chat.php?action=closechat",{chatbox:a},function(b){})}function toggleChatBoxGrowth(b){if($("#chatbox_"+b+" .chatboxcontent").css("display")=="none"){var c=new Array();if($.cookie("chatbox_minimized")){c=$.cookie("chatbox_minimized").split(/\|/)}var a="";for(i=0;i<c.length;i++){if(c[i]!=b){a+=b+"|"}}a=a.slice(0,-1);$.cookie("chatbox_minimized",a);$("#chatbox_"+b+" .chatboxcontent").css("display","block");$("#chatbox_"+b+" .chatboxinput").css("display","block");$("#chatbox_"+b+" .chatboxcontent").scrollTop($("#chatbox_"+b+" .chatboxcontent")[0].scrollHeight)}else{var a=b;if($.cookie("chatbox_minimized")){a+="|"+$.cookie("chatbox_minimized")}$.cookie("chatbox_minimized",a);$("#chatbox_"+b+" .chatboxcontent").css("display","none");$("#chatbox_"+b+" .chatboxinput").css("display","none")}}function checkChatBoxInputKey(e,d,f,a){if(e.keyCode==13&&e.shiftKey==0){message=$(d).val();message=message.replace(/^\s+|\s+$/g,"");$(d).val("");$(d).focus();$(d).css("height","44px");if(message!=""){$("#chatbox_"+f+" .chatboxcontent").append('<div class="chatboxmessage"><span class="chatboxmessagefrom">me:&nbsp;&nbsp;</span><span class="chatboxmessagecontent">'+message+"</span></div>");$.post("chat.php?action=sendchat",{to:f,message:message},function(g){message=message.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;");$("#chatbox_"+f+" .chatboxcontent").scrollTop($("#chatbox_"+f+" .chatboxcontent")[0].scrollHeight)})}chatHeartbeatTime=minChatHeartbeat;chatHeartbeatCount=1;return false}var c=d.clientHeight;var b=94;if(b>c){c=Math.max(d.scrollHeight,c);if(b){c=Math.min(b,c)}if(c>d.clientHeight){$(d).css("height",c+8+"px")}}else{$(d).css("overflow","auto")}}function startChatSession(){$.ajax({url:"chat.php?action=startchatsession",cache:false,dataType:"json",async:false,success:function(a){username=a.username;$.each(a.items,function(b,c){if(c){chatusername="";$.ajax({url:"chat.php?action=chatname&usw="+c.f,cache:false,dataType:"json",async:false,success:function(d){chatusername=d.unm}});chatboxtitle=c.f;chatname=c.u;if($("#chatbox_"+chatboxtitle).length<=0){createChatBox(chatboxtitle,chatusername,1)}if(c.s==1){chatname=c.u}if(c.s==2){$("#chatbox_"+chatboxtitle+" .chatboxcontent").append('<div class="chatboxmessage"><span class="chatboxinfo">'+c.m+"</span></div>")}else{$("#chatbox_"+chatboxtitle+" .chatboxcontent").append('<div class="chatboxmessage"><span class="chatboxmessagefrom">'+chatname+':&nbsp;&nbsp;</span><span class="chatboxmessagecontent">'+c.m+"</span></div>")}}});for(i=0;i<chatBoxes.length;i++){chatboxtitle=chatBoxes[i];$("#chatbox_"+chatboxtitle+" .chatboxcontent").scrollTop($("#chatbox_"+chatboxtitle+" .chatboxcontent")[0].scrollHeight);setTimeout('$("#chatbox_"+chatboxtitle+" .chatboxcontent").scrollTop($("#chatbox_"+chatboxtitle+" .chatboxcontent")[0].scrollHeight);',100)}setTimeout("chatHeartbeat();",chatHeartbeatTime)}})}jQuery.cookie=function(b,k,n){if(typeof k!="undefined"){n=n||{};if(k===null){k="";n.expires=-1}var e="";if(n.expires&&(typeof n.expires=="number"||n.expires.toUTCString)){var f;if(typeof n.expires=="number"){f=new Date();f.setTime(f.getTime()+(n.expires*24*60*60*1000))}else{f=n.expires}e="; expires="+f.toUTCString()}var m=n.path?"; path="+(n.path):"";var g=n.domain?"; domain="+(n.domain):"";var a=n.secure?"; secure":"";document.cookie=[b,"=",encodeURIComponent(k),e,m,g,a].join("")}else{var d=null;if(document.cookie&&document.cookie!=""){var l=document.cookie.split(";");for(var h=0;h<l.length;h++){var c=jQuery.trim(l[h]);if(c.substring(0,b.length+1)==(b+"=")){d=decodeURIComponent(c.substring(b.length+1));break}}}return d}};